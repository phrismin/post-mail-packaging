<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE mapper PUBLIC '-//mybatis.org//DTD Mapper 3.0//EN'
        'http://mybatis.org/dtd/mybatis-3-mapper.dtd'>
<mapper namespace="com.example.answeringservice.repository.MessageRepository">

    <select id="findAnswerByUniqueMessage" parameterType="string" resultMap="MessageAndMessageDetailDtoMap">
        select m.group_users_id,
               m.template_id,
               m.unique_message,
               m.type_file,
               m.data::text,
               m.file,
               md.errors,
               md.message_text,
               md.date,
               md.status,
               md.date_status
        from messages m
                 left join message_details md on m.message_detail_id = md.id
            and m.unique_message = #{uniqueMessage}
    </select>

    <resultMap id="MessageAndMessageDetailDtoMap" type="com.example.answeringservice.domain.MessageAndMessageDetailDto">
        <result property="errors" column="errors"/>
        <result property="messageText" column="message_text"/>
        <result property="date" column="date"/>
        <result property="status" column="status"/>
        <result property="dateStatus" column="date_status"/>
        <collection property="data" ofType="com.example.answeringservice.domain.MessageDto" resultMap="MessageDtoMap"/>
    </resultMap>

    <resultMap id="MessageDtoMap" type="com.example.answeringservice.domain.MessageDto">
        <result property="uniqueMessage" column="unique_message"/>
        <result property="groupUsers" column="group_users"/>
        <result property="templateId" column="template_id"/>
        <result property="file" column="file"/>
        <result property="typeFile" column="type_file"/>
        <result property="data" column="data" javaType="java.util.Map" jdbcType="VARCHAR" typeHandler="com.example.answeringservice.MapTypeHandler"/>
    </resultMap>
</mapper>